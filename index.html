<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0D9488">
  <title>Health & Wellness Coach</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      overflow-x: hidden;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
    .animate-slideUp { animation: slideUp 0.3s ease-out; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Define questions OUTSIDE the component so they're stable
    const QUESTIONS = [
      { key: 'goal', text: "What's your health goal?", placeholder: "e.g., lose weight, build muscle..." },
      { key: 'currentActivity', text: "Are you currently working out?", placeholder: "e.g., gym 3x/week..." },
      { key: 'weekdayRoutine', text: "Walk me through your typical weekday", placeholder: "e.g., wake at 7am, work 9-6..." },
      { key: 'weekendRoutine', text: "What does a typical weekend look like?", placeholder: "e.g., sleep in, brunch..." },
      { key: 'barriers', text: "What's been stopping you?", placeholder: "e.g., no time, no motivation..." },
    ];

    // ============ CONFIGURATION ============
    const CONFIG = {
      GOOGLE_CLIENT_ID: '',
      GOOGLE_API_KEY: '',
      ANTHROPIC_API_KEY: '',
    };

    // ============ CALENDAR INTEGRATION ============
    const useCalendar = () => {
      const [isConnected, setIsConnected] = useState(false);
      const [events, setEvents] = useState([]);
      const [isLoading, setIsLoading] = useState(false);

      useEffect(() => {
        if (CONFIG.GOOGLE_CLIENT_ID && CONFIG.GOOGLE_API_KEY) {
          gapi.load('client:auth2', () => {
            gapi.client.init({
              apiKey: CONFIG.GOOGLE_API_KEY,
              clientId: CONFIG.GOOGLE_CLIENT_ID,
              discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
              scope: 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events',
            }).then(() => {
              const authInstance = gapi.auth2.getAuthInstance();
              setIsConnected(authInstance.isSignedIn.get());
            });
          });
        }
      }, []);

      const connect = async () => {
        setIsLoading(true);
        try {
          const auth = gapi.auth2.getAuthInstance();
          await auth.signIn();
          setIsConnected(true);
          
          const result = await analyzeCalendar();
          setIsLoading(false);
          return result;
        } catch (error) {
          console.error('Calendar error:', error);
          setIsLoading(false);
          return null;
        }
      };

      const analyzeCalendar = async () => {
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(nextWeek.getDate() + 7);

        try {
          const response = await gapi.client.calendar.events.list({
            calendarId: 'primary',
            timeMin: today.toISOString(),
            timeMax: nextWeek.toISOString(),
            showDeleted: false,
            singleEvents: true,
            orderBy: 'startTime',
          });

          const calendarEvents = response.result.items || [];
          setEvents(calendarEvents);

          const freeBlocks = [];
          calendarEvents.forEach((event, index) => {
            if (index < calendarEvents.length - 1) {
              const currentEnd = new Date(event.end.dateTime || event.end.date);
              const nextStart = new Date(calendarEvents[index + 1].start.dateTime || calendarEvents[index + 1].start.date);
              const gapMinutes = (nextStart.getTime() - currentEnd.getTime()) / 60000;

              if (gapMinutes >= 30) {
                freeBlocks.push({
                  day: currentEnd.toLocaleDateString(),
                  start: currentEnd.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                  end: nextStart.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                });
              }
            }
          });

          return { events: calendarEvents, freeBlocks };
        } catch (error) {
          console.error('Error analyzing calendar:', error);
          return { events: [], freeBlocks: [] };
        }
      };

      const addWorkout = async (workout) => {
        if (!isConnected) return null;

        const endTime = new Date(new Date(workout.startTime).getTime() + workout.duration * 60000).toISOString();
        
        const event = {
          summary: workout.name,
          description: workout.description,
          start: {
            dateTime: workout.startTime,
            timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          },
          end: {
            dateTime: endTime,
            timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          },
          reminders: {
            useDefault: false,
            overrides: [{ method: 'popup', minutes: 10 }],
          },
        };

        try {
          const response = await gapi.client.calendar.events.insert({
            calendarId: 'primary',
            resource: event,
          });
          return response.result;
        } catch (error) {
          console.error('Error adding workout:', error);
          return null;
        }
      };

      return { isConnected, connect, events, addWorkout, isLoading };
    };

    // ============ AI COACH WITH MEMORY ============
    const useAICoach = (userContext) => {
      const [conversationHistory, setConversationHistory] = useState([]);
      const [isLoading, setIsLoading] = useState(false);

      useEffect(() => {
        if (userContext.userData.goal) {
          const contextMessage = {
            role: 'assistant',
            content: `You are a personal fitness coach. User context: Goal: ${userContext.userData.goal}, Barriers: ${userContext.onboardingAnswers?.barriers}, Routine: ${userContext.onboardingAnswers?.weekdayRoutine}. Remember this throughout our conversation.`
          };
          setConversationHistory([contextMessage]);
        }
      }, [userContext.userData.goal]);

      const sendMessage = async (userMessage) => {
        const newUserMsg = { role: 'user', content: userMessage };
        setConversationHistory(prev => [...prev, newUserMsg]);
        setIsLoading(true);

        try {
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          const recentMsgs = conversationHistory.slice(-3);
          const hasDiscussedIntensity = recentMsgs.some(m => m.content.toLowerCase().includes('intense'));
          const hasDiscussedTiming = recentMsgs.some(m => m.content.toLowerCase().includes('morning'));

          let response = '';
          if (userMessage.toLowerCase().includes('too hard') || userMessage.toLowerCase().includes('intense')) {
            response = `I remember you mentioned "${userContext.onboardingAnswers?.barriers}" as a challenge. Let me reduce intensity by 20%. ${hasDiscussedIntensity ? "Like we discussed, we'll keep it manageable." : ""}`;
          } else if (userMessage.toLowerCase().includes('morning') || userMessage.toLowerCase().includes('time')) {
            response = `Based on your ${userContext.onboardingAnswers?.weekdayRoutine}, I've adjusted the schedule. ${hasDiscussedTiming ? "This should work better." : ""}`;
          } else {
            response = `Got it - I've updated your plan considering ${userContext.onboardingAnswers?.barriers}. Let me know if you need any other adjustments!`;
          }

          const assistantMsg = { role: 'assistant', content: response };
          setConversationHistory(prev => [...prev, assistantMsg]);
          setIsLoading(false);
          return response;
        } catch (error) {
          console.error('AI error:', error);
          setIsLoading(false);
          return "Sorry, I had trouble with that. Can you try again?";
        }
      };

      return { sendMessage, conversationHistory, isLoading };
    };

    // ============ MAIN APP STATE ============
    const useAppState = () => {
      const [currentView, setCurrentView] = useState("onboarding");
      const [onboardingStep, setOnboardingStep] = useState(0);
      const [transcript, setTranscript] = useState("");
      const [isListening, setIsListening] = useState(false);
      const [useMetric, setUseMetric] = useState(false);
      const [isGenerating, setIsGenerating] = useState(false);

      const [userData, setUserData] = useState({
        goal: "", currentActivity: "", weekdayRoutine: "", weekendRoutine: "",
        barriers: "", weight: "", height: "", age: "", gender: "",
      });

      const [onboardingAnswers, setOnboardingAnswers] = useState({
        goal: "", currentActivity: "", weekdayRoutine: "", weekendRoutine: "", barriers: "",
      });

      const [recommendations, setRecommendations] = useState(null);
      const [weeklyPlan, setWeeklyPlan] = useState([]);
      const [completedActivities, setCompletedActivities] = useState(new Set());
      const [chatHistory, setChatHistory] = useState([]);

      const calendar = useCalendar();
      const aiCoach = useAICoach({ userData, weeklyPlan, completedActivities, onboardingAnswers });

      const recognition = useRef(null);
      useEffect(() => {
        if ('webkitSpeechRecognition' in window) {
          recognition.current = new webkitSpeechRecognition();
          recognition.current.continuous = true;
          recognition.current.interimResults = true;

          recognition.current.onresult = (event) => {
            let final = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
              if (event.results[i].isFinal) {
                final += event.results[i][0].transcript + ' ';
              }
            }
            if (final) setTranscript(final);
          };

          recognition.current.onerror = () => setIsListening(false);
          recognition.current.onend = () => setIsListening(false);
        }
      }, []);

      const toggleListening = () => {
        if (isListening) {
          recognition.current?.stop();
        } else {
          setTranscript("");
          recognition.current?.start();
        }
        setIsListening(!isListening);
      };

      const handleOnboardingNext = () => {
        setOnboardingAnswers(prev => ({ ...prev, [QUESTIONS[onboardingStep].key]: transcript }));
        setTranscript("");
        if (onboardingStep < QUESTIONS.length - 1) {
          setOnboardingStep(onboardingStep + 1);
        } else {
          setCurrentView("stats");
        }
      };

      const handleOnboardingBack = () => {
        if (onboardingStep > 0) setOnboardingStep(onboardingStep - 1);
      };

      const generateRecommendations = async () => {
        setIsGenerating(true);
        setCurrentView("recommendations");

        const plan = [
          { time: '07:00', duration: 30, type: 'workout', name: 'Morning Cardio', description: '20 min jog + 10 min stretching', color: '#4F46E5' },
          { time: '12:30', duration: 45, type: 'meal', name: 'Lunch Break', description: 'Healthy balanced meal', color: '#10B981' },
          { time: '18:00', duration: 45, type: 'workout', name: 'Strength Training', description: 'Upper body focus', color: '#F59E0B' },
          { time: '22:00', duration: 30, type: 'stretch', name: 'Evening Wind Down', description: 'Light stretching', color: '#8B5CF6' },
        ];

        setWeeklyPlan(plan);
        setRecommendations({
          goals: [
            `${onboardingAnswers.goal} - target measurable progress in 4 weeks`,
            "Build consistent exercise habit - 80% completion",
            "Improve energy through regular movement",
          ],
          insights: `Based on your ${onboardingAnswers.weekdayRoutine.includes('9') ? 'busy schedule' : 'routine'}, I've scheduled workouts during your free time.`
        });

        setTimeout(() => setIsGenerating(false), 2000);
      };

      const sendChat = async (message) => {
        setChatHistory(prev => [...prev, { role: 'user', content: message }]);
        const response = await aiCoach.sendMessage(message);
        setChatHistory(prev => [...prev, { role: 'assistant', content: response }]);
      };

      const toggleActivity = (name) => {
        setCompletedActivities(prev => {
          const newSet = new Set(prev);
          newSet.has(name) ? newSet.delete(name) : newSet.add(name);
          return newSet;
        });
      };

      const syncWorkouts = async () => {
        if (!calendar.isConnected) {
          alert("Please connect calendar first");
          return;
        }

        for (const workout of weeklyPlan.filter(w => w.type === 'workout')) {
          const [hours, minutes] = workout.time.split(':');
          const startTime = new Date();
          startTime.setHours(parseInt(hours), parseInt(minutes), 0);

          await calendar.addWorkout({
            name: workout.name,
            description: workout.description,
            startTime: startTime.toISOString(),
            duration: workout.duration,
          });
        }
        alert("Workouts synced to calendar!");
      };

      return {
        currentView, setCurrentView, onboardingStep, isListening, toggleListening,
        transcript, setTranscript, useMetric, setUseMetric, userData, setUserData,
        recommendations, weeklyPlan, completedActivities, toggleActivity,
        chatHistory, sendChat, handleOnboardingNext, handleOnboardingBack,
        generateRecommendations, isGenerating,
        isCalendarConnected: calendar.isConnected,
        connectCalendar: calendar.connect,
        syncWorkouts,
        onboardingAnswers,
      };
    };

    // ============ ICONS ============
    const Mic = () => (
      <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/>
      </svg>
    );

    const MicOff = () => (
      <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
        <line x1="2" y1="2" x2="22" y2="22"/><path d="M18.89 13.23A7.12 7.12 0 0 0 19 12v-2"/><path d="M5 10v2a7 7 0 0 0 12 5"/>
      </svg>
    );

    const Check = ({size = 20}) => (
      <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    );

    const Calendar = ({size = 20}) => (
      <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
        <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
    );

    const MessageCircle = ({size = 24}) => (
      <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
      </svg>
    );

    const TrendingUp = ({size = 24}) => (
      <svg width={size} height={size} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
        <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/>
      </svg>
    );

    const X = () => (
      <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    );

    // ============ COMPONENTS ============
    const Onboarding = ({ step, transcript, setTranscript, isListening, toggleListening, onNext, onBack }) => (
      <div className="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 px-6 py-12">
        <div className="max-w-2xl mx-auto">
          <div className="flex gap-2 mb-8">
            {QUESTIONS.map((_, idx) => (
              <div key={idx} className={`h-1 flex-1 rounded-full transition-all ${idx <= step ? 'bg-teal-600' : 'bg-teal-200'}`} />
            ))}
          </div>

          <h1 className="text-2xl font-light text-slate-800 mb-6 leading-relaxed">{QUESTIONS[step].text}</h1>
          
          <div className="text-lg text-slate-600 leading-relaxed mb-8 min-h-[60px]">
            {transcript ? <span className="animate-fadeIn">{transcript}</span> : <span className="text-slate-400 italic">{QUESTIONS[step].placeholder}</span>}
          </div>

          <div className="space-y-4">
            <div className="flex gap-4 flex-wrap">
              <button
                onClick={toggleListening}
                className={`flex items-center gap-3 px-8 py-4 rounded-full shadow-lg transition-all ${isListening ? 'bg-red-500 hover:bg-red-600' : 'bg-teal-600 hover:bg-teal-700'} text-white`}
              >
                {isListening ? <MicOff /> : <Mic />}
                <span>{isListening ? 'Stop' : 'Tap to speak'}</span>
              </button>
              
              {transcript && (
                <button onClick={onNext} className="px-8 py-4 bg-slate-800 text-white rounded-full hover:bg-slate-900 shadow-lg">
                  Continue
                </button>
              )}
              
              {step > 0 && (
                <button onClick={onBack} className="px-8 py-4 bg-white text-slate-600 rounded-full hover:bg-slate-50 shadow">
                  Back
                </button>
              )}
            </div>

            <div>
              <label className="block text-sm text-slate-600 mb-2">Or type your answer</label>
              <textarea
                value={transcript}
                onChange={(e) => setTranscript(e.target.value)}
                placeholder={QUESTIONS[step].placeholder}
                className="w-full min-h-[100px] p-4 border border-slate-200 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-teal-500"
              />
            </div>
          </div>
        </div>
      </div>
    );

    const StatsForm = ({ useMetric, setUseMetric, userData, setUserData, onSubmit }) => (
      <div className="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 px-6 py-12">
        <div className="max-w-2xl mx-auto">
          <h1 className="text-2xl font-light text-slate-800 mb-8">Just a few more details</h1>

          <div className="bg-white rounded-3xl p-8 shadow-sm space-y-6">
            <div className="flex justify-between items-center mb-6">
              <span className="text-slate-700">Units</span>
              <div className="flex gap-2 bg-slate-100 rounded-full p-1">
                <button onClick={() => setUseMetric(false)} className={`px-4 py-2 rounded-full ${!useMetric ? 'bg-white shadow-sm' : 'text-slate-600'}`}>Imperial</button>
                <button onClick={() => setUseMetric(true)} className={`px-4 py-2 rounded-full ${useMetric ? 'bg-white shadow-sm' : 'text-slate-600'}`}>Metric</button>
              </div>
            </div>

            {[
              { label: `Weight (${useMetric ? 'kg' : 'lbs'})`, key: 'weight', type: 'number' },
              { label: `Height (${useMetric ? 'cm' : 'in'})`, key: 'height', type: 'number' },
              { label: 'Age', key: 'age', type: 'number' },
            ].map(field => (
              <div key={field.key}>
                <label className="block text-sm text-slate-600 mb-2">{field.label}</label>
                <input
                  type={field.type}
                  value={userData[field.key]}
                  onChange={(e) => setUserData({...userData, [field.key]: e.target.value})}
                  className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500"
                />
              </div>
            ))}

            <div>
              <label className="block text-sm text-slate-600 mb-2">Gender</label>
              <select
                value={userData.gender}
                onChange={(e) => setUserData({...userData, gender: e.target.value})}
                className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500"
              >
                <option value="">Select...</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
                <option value="prefer-not">Prefer not to say</option>
              </select>
            </div>

            <button onClick={onSubmit} className="w-full py-4 bg-teal-600 text-white rounded-xl hover:bg-teal-700 shadow-lg mt-6">
              Continue
            </button>
          </div>
        </div>
      </div>
    );

    const AuthPage = ({ onComplete, onSkip, connectCalendar, isCalendarConnected }) => {
      const [email, setEmail] = useState("");
      const [isConnecting, setIsConnecting] = useState(false);

      const handleConnect = async () => {
        setIsConnecting(true);
        const result = await connectCalendar();
        if (result) alert(`Found ${result.freeBlocks.length} free time blocks!`);
        setIsConnecting(false);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 px-6 py-12">
          <div className="max-w-2xl mx-auto">
            <h1 className="text-3xl font-light text-slate-800 mb-4">Almost there!</h1>
            <p className="text-slate-600 mb-8">Create an account to save your progress</p>

            <div className="bg-white rounded-3xl p-8 shadow-sm space-y-6">
              <div>
                <label className="block text-sm text-slate-600 mb-2">Email</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="your@email.com"
                  className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500"
                />
              </div>

              <div className="border-t border-slate-200 pt-6">
                <div className="flex gap-4 mb-4">
                  <div className="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0">
                    {isCalendarConnected ? <Check /> : <Calendar />}
                  </div>
                  <div>
                    <h3 className="font-medium text-slate-800 mb-1">
                      {isCalendarConnected ? "Calendar Connected!" : "Connect Your Calendar"}
                    </h3>
                    <p className="text-sm text-slate-600">
                      {isCalendarConnected ? "We'll schedule around your events" : "Find best times for workouts"}
                    </p>
                  </div>
                </div>

                {!isCalendarConnected && CONFIG.GOOGLE_CLIENT_ID && (
                  <button
                    onClick={handleConnect}
                    disabled={isConnecting}
                    className="w-full py-3 border border-slate-300 rounded-xl hover:bg-slate-50 flex items-center justify-center gap-2"
                  >
                    <Calendar size={16} />
                    {isConnecting ? "Connecting..." : "Connect Google Calendar"}
                  </button>
                )}
              </div>

              <div className="flex gap-4">
                <button onClick={onComplete} disabled={!email} className="flex-1 py-4 bg-teal-600 text-white rounded-xl hover:bg-teal-700 disabled:opacity-50">
                  Create Account
                </button>
                <button onClick={onSkip} className="px-8 py-4 text-slate-600 hover:bg-slate-50 rounded-xl">
                  Skip
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const Recommendations = ({ recommendations, isGenerating, onViewCalendar, syncWorkouts, isCalendarConnected }) => (
      <div className="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 px-6 py-12">
        <div className="max-w-2xl mx-auto">
          {isGenerating ? (
            <div className="text-center py-20">
              <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-teal-600 mx-auto mb-4"></div>
              <p className="text-slate-600">Generating your personalized plan...</p>
            </div>
          ) : (
            <>
              <h1 className="text-3xl font-light text-slate-800 mb-4">Your Personalized Plan</h1>
              <p className="text-slate-600 mb-8">{recommendations?.insights}</p>

              <h2 className="text-xl font-medium text-slate-800 mb-4">Your Goals</h2>
              <div className="space-y-4 mb-8">
                {recommendations?.goals.map((goal, idx) => (
                  <div key={idx} className="bg-white rounded-2xl p-6 shadow-sm flex gap-4">
                    <div className="w-8 h-8 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                      <span className="text-teal-700 font-semibold">{idx + 1}</span>
                    </div>
                    <p className="text-slate-700 leading-relaxed">{goal}</p>
                  </div>
                ))}
              </div>

              <div className="flex gap-4 flex-wrap">
                <button onClick={onViewCalendar} className="flex-1 py-4 bg-teal-600 text-white rounded-xl hover:bg-teal-700 shadow-lg">
                  View Calendar
                </button>
                {isCalendarConnected && (
                  <button onClick={syncWorkouts} className="px-6 py-4 bg-white text-teal-600 rounded-xl hover:bg-slate-50 border border-teal-200">
                    Sync to Calendar
                  </button>
                )}
              </div>
            </>
          )}
        </div>
      </div>
    );

    const CalendarView = ({ weeklyPlan, completedActivities, toggleActivity, setCurrentView }) => (
      <div className="min-h-screen bg-slate-50 pb-24">
        <div className="bg-gradient-to-r from-teal-600 to-emerald-600 text-white px-6 py-6">
          <h1 className="text-2xl font-light mb-2">Today's Schedule</h1>
          <p className="text-teal-100">Wednesday, February 7</p>
        </div>

        <div className="px-6 py-6 space-y-3">
          {weeklyPlan.map((activity, idx) => (
            <div key={idx} className="bg-white rounded-2xl p-5 shadow-sm border-l-4 flex justify-between" style={{borderColor: activity.color}}>
              <div>
                <div className="text-sm text-slate-500 font-medium mb-2">{activity.time} Â· {activity.duration} min</div>
                <h3 className="text-lg font-medium text-slate-800 mb-1">{activity.name}</h3>
                <p className="text-sm text-slate-600">{activity.description}</p>
              </div>
              <button
                onClick={() => toggleActivity(activity.name)}
                className={`w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 ${
                  completedActivities.has(activity.name) ? 'bg-teal-600 border-teal-600' : 'border-slate-300'
                }`}
              >
                {completedActivities.has(activity.name) && <Check size={16} />}
              </button>
            </div>
          ))}
        </div>

        <div className="fixed bottom-0 left-0 right-0 bg-white border-t px-6 py-4 flex justify-around shadow-lg">
          <button onClick={() => setCurrentView('calendar')} className="flex flex-col items-center gap-1 text-teal-600">
            <Calendar /><span className="text-xs font-medium">Calendar</span>
          </button>
          <button className="flex flex-col items-center gap-1 text-slate-400">
            <MessageCircle /><span className="text-xs font-medium">Chat</span>
          </button>
          <button onClick={() => setCurrentView('dashboard')} className="flex flex-col items-center gap-1 text-slate-400">
            <TrendingUp /><span className="text-xs font-medium">Progress</span>
          </button>
        </div>
      </div>
    );

    const Dashboard = ({ weeklyPlan, completedActivities, setCurrentView }) => {
      const total = weeklyPlan.filter(a => a.type === 'workout' || a.type === 'stretch').length;
      const completed = Array.from(completedActivities).filter(name => 
        weeklyPlan.some(a => a.name === name && (a.type === 'workout' || a.type === 'stretch'))
      ).length;
      const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

      return (
        <div className="min-h-screen bg-slate-50 pb-24">
          <div className="bg-gradient-to-r from-teal-600 to-emerald-600 text-white px-6 py-6">
            <h1 className="text-2xl font-light">Your Progress</h1>
          </div>

          <div className="px-6 py-6 space-y-6">
            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <h2 className="text-lg font-medium text-slate-800 mb-4">Today</h2>
              <div className="flex justify-between items-center mb-4">
                <span className="text-4xl font-light text-teal-600">{rate}%</span>
                <span className="text-slate-600">{completed} of {total} completed</span>
              </div>
              <div className="w-full bg-slate-100 rounded-full h-3">
                <div className="bg-teal-600 rounded-full h-3 transition-all" style={{width: `${rate}%`}}></div>
              </div>
            </div>

            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <h2 className="text-lg font-medium text-slate-800 mb-4">This Week</h2>
              <div className="grid grid-cols-2 gap-4">
                <div><div className="text-3xl font-light text-slate-800 mb-1">3</div><div className="text-sm text-slate-600">Day Streak</div></div>
                <div><div className="text-3xl font-light text-slate-800 mb-1">8</div><div className="text-sm text-slate-600">Workouts</div></div>
              </div>
            </div>
          </div>

          <div className="fixed bottom-0 left-0 right-0 bg-white border-t px-6 py-4 flex justify-around shadow-lg">
            <button onClick={() => setCurrentView('calendar')} className="flex flex-col items-center gap-1 text-slate-400">
              <Calendar /><span className="text-xs font-medium">Calendar</span>
            </button>
            <button className="flex flex-col items-center gap-1 text-slate-400">
              <MessageCircle /><span className="text-xs font-medium">Chat</span>
            </button>
            <button onClick={() => setCurrentView('dashboard')} className="flex flex-col items-center gap-1 text-teal-600">
              <TrendingUp /><span className="text-xs font-medium">Progress</span>
            </button>
          </div>
        </div>
      );
    };

    const FloatingChat = ({ chatHistory, sendChat }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [input, setInput] = useState("");

      const handleSend = () => {
        if (input.trim()) {
          sendChat(input);
          setInput("");
        }
      };

      if (!isOpen) {
        return (
          <button
            onClick={() => setIsOpen(true)}
            className="fixed bottom-24 right-6 w-14 h-14 bg-teal-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-teal-700 z-50"
          >
            <MessageCircle size={24} />
          </button>
        );
      }

      return (
        <div className="fixed bottom-24 right-6 w-80 bg-white rounded-2xl shadow-2xl flex flex-col max-h-[500px] animate-slideUp z-50">
          <div className="bg-teal-600 text-white p-4 rounded-t-2xl flex justify-between items-center">
            <h3 className="font-medium">AI Coach</h3>
            <button onClick={() => setIsOpen(false)} className="text-white"><X /></button>
          </div>

          <div className="flex-1 overflow-y-auto p-4 space-y-3">
            {chatHistory.length === 0 && (
              <p className="text-sm text-slate-400 text-center py-8">Ask me to adjust your plan!</p>
            )}
            {chatHistory.filter(msg => msg.role !== 'assistant' || !msg.content.includes('personal fitness coach')).map((msg, idx) => (
              <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[80%] px-3 py-2 rounded-2xl text-sm ${msg.role === 'user' ? 'bg-teal-600 text-white' : 'bg-slate-100 text-slate-800'}`}>
                  {msg.content}
                </div>
              </div>
            ))}
          </div>

          <div className="p-4 border-t flex gap-2">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleSend()}
              placeholder="Type a message..."
              className="flex-1 px-3 py-2 border rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
            />
            <button onClick={handleSend} className="px-4 py-2 bg-teal-600 text-white rounded-xl text-sm hover:bg-teal-700">
              Send
            </button>
          </div>
        </div>
      );
    };

    // ============ MAIN APP ============
    const App = () => {
      const state = useAppState();

      const renderView = () => {
        switch(state.currentView) {
          case "onboarding":
            return <Onboarding {...state} step={state.onboardingStep} />;
          case "stats":
            return <StatsForm {...state} onSubmit={() => state.setCurrentView("auth")} />;
          case "auth":
            return <AuthPage onComplete={state.generateRecommendations} onSkip={state.generateRecommendations} {...state} />;
          case "recommendations":
            return <Recommendations {...state} onViewCalendar={() => state.setCurrentView("calendar")} />;
          case "calendar":
            return <CalendarView {...state} />;
          case "dashboard":
            return <Dashboard {...state} />;
          default:
            return null;
        }
      };

      const showChat = state.currentView === "calendar" || state.currentView === "dashboard";

      return (
        <>
          {renderView()}
          {showChat && <FloatingChat chatHistory={state.chatHistory} sendChat={state.sendChat} />}
        </>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
